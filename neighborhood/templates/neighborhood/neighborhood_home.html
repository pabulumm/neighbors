<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    {% load staticfiles %}
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'neighborhood/home.css' %}" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
    <meta charset="UTF-8">
    <title>Neighbors</title>
</head>
<body>

    <div class="jumbotron">
        <div class="container">
            <h1>Welcome to the Neighborhood!</h1>
            <p>{{ neighborhood.division_title }} Division</p>
        </div> <!-- end container -->
    </div>

    <div class="nav">
        <div class="container">
            <ul class="nav nav-pills">
                <li><a href="{% url 'neighborhood:neighborhood_home' %}">Home</a></li>
                <li><a class="active" href="{% url 'polls:index' %}">Polls</a></li>
				<li><a href="{% url 'discussions:index' %}">Discussions</a></li>
                <li><a href="{% url 'budget:manage' %}">Budget</a></li>
                <li><a href="{% url 'neighborhood:about' %}">About Neighbors</a></li>
                <li><a href="{% url 'accounts:user_profile' %}">Manage Account</a></li>
                <li><a href="{% url 'accounts:user_logout' %}">Sign out</a></li>
            </ul>
        </div> <!-- end container -->
    </div>


    <div class="map_box">
        <div class="container">


       </div>
    </div>

            <div id="map" class="map">
                <nav class='menu-ui'>
                        <a id="road_block">Road Blocks</a>
                        <a href="#" id="construction">Construction</a>
                        <a href="#" id="theft">Theft</a>
                        <a href="#" id="expense">Expense</a>
                        <a href="#" id="yard_sale">Yard Sale</a>
                        <a href="#" id="pool_spa">Pool/Spa</a>
                        <a href="#" id="trash">Trash</a>
                        <a href="#" id="hazard">Hazard</a>
                        <a id="new_marker">New Marker</a>

                </nav>
            </div>

                <!-- MAPBOX.JS SCRIPT -->
    <script>
        //For getting CSRF token
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Grab csrf token for AJAX calls
        var csrftoken = getCookie('csrftoken');

        // Load the access token and load the map at the neighborhood center
        // TBD add custom center point for neighborhood map loading
        L.mapbox.accessToken = 'pk.eyJ1IjoicGFidWx1bSIsImEiOiIwZTUwZmViZjQxZjYyMDJmNTQ0ZDY3YTdkNDE5ZjM0ZCJ9.MZqD7DtnmRFQfWLMGRMP_w';
        var map = L.mapbox.map('map', 'mapbox.streets').setView([34.220912, -119.055079], 16);

        // Create holders for new marker info
        var name;
        var lat,lon;
        var marker;

        $(document).ready(function() {
            $.ajax({
                url: "{% url 'markers:get_all_markers' %}",
                type: 'GET',
                data : {
                    csrfmiddlewaretoken: csrftoken
                },
                success : function(json) {
                    console.log(json);
                    $(json['markers']).each(function() {
                        L.marker([this.lat,this.lon]).addTo(map);
                    })
                },
                error : function(xhr,errmsg,err) {
                    alert('ERROR: ' + xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
            })
        });

        map.on('click', function(e) {
            // create a variable to hold to new marker
            marker = L.marker(e.latlng).addTo(map);
            marker.bindPopup('<button id="save" class="save">Save</button>' +
                '<button class="cancel">Cancel</button>').openPopup();

            // grab the position of the click
            name = "Test Name";
            lat = e.latlng.lat;
            lon = e.latlng.lng;
        });

        $('#new_marker').on('click', function() {

        });

        $('#map').on('click', '.cancel', function() {
            map.removeLayer(marker);
            alert('Marker removed');
        });

        $('#map').on('click', '.save', function() {
            // AJAX call to save new marker as GeoDjango model
            $.ajax({
                url: "{% url 'markers:new_marker' %}",
                type: "Post",
                data : {
                    name: name,
                    lat: lat,
                    lon: lon,
                    csrfmiddlewaretoken: csrftoken
                },
                success : function(json) {
                    console.log(json);
                    alert('Created a House marker at latitude:' + json['lat'] + ' and longitude:' + json['lon'])
                },
                error : function(xhr,errmsg,err) {
                    alert('ERROR: ' + xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
            })
        });
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
    </script>


    <div class="content">
        <div class="container">
            <p>Division Title: {{ neighborhood.division_title }}</p>
            <p>Division ID: {{ neighborhood.id }}</p>
            <p>Division Creation date: {{ neighborhood.create_date }}</p>
            <p>Division Residence Fee: {{ neighborhood.residence_fee }}</p>
        </div> <!-- end container -->

    </div>


    <div class="footer">
		<div class="container">
			<div class="row">
				<div class="col-md-4">
					<h3>About</h3>
					<p>Info/links regarding Neighbors information.</p>
				</div>
				<div class="col-md-4">
					<h3>Contact</h3>
					<p>Info/links for contacting Neighbors peeps</p>
				</div>
				<div class="col-md-4">
					<h3>Help</h3>
					<p>Help and FAQ shit.</p>
				</div>
			</div> <!-- end row -->
		</div> <!-- end container -->
	</div> <!-- end footer -->


</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8/>
    {% load staticfiles %}
    <title>Neighbors</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.4/d3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          crossorigin="anonymous">
    <link href='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.css' rel='stylesheet'/>
    {# <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' /> #}
    <link rel="stylesheet" type="text/css" href="{% static 'neighborhood/css/map_home.css' %}"/>


</head>
<body>

<div class="nav">
    <h1 class="white-text">Neighbors</h1>
    <div class="options">
        <a class="btn btn-info" href="{% url 'neighborhood:home' %}"><strong>map</strong></a>
        <a class="btn btn-info" href="{% url 'neighborhood:status' %}"><strong>status</strong></a>
    </div>
    <div class="icons">
        <a id="account" class='btn btn-default btn-circle btn-lg' href="{% url 'accounts:user_profile' %}">
            <span class='glyphicon glyphicon-user'></span>
        </a>
        <a id="messages" class='btn btn-default btn-circle btn-lg' href="{% url 'accounts:user_profile' %}">
            <span class='glyphicon glyphicon-envelope'></span>
        </a>
        <a id="list" class='btn btn-default btn-circle btn-lg' href="{% url 'neighborhood:details' %}">
            <span class='glyphicon glyphicon-list'></span>
        </a>
        <a id="report" class='btn btn-default btn-circle btn-lg'>
            <span class='glyphicon glyphicon-alert'></span>
        </a>
    </div>
</div>

<div id="report-container">
    <a id="cancel" class="btn btn-circle"><span class="glyphicon glyphicon-remove"></span></a>
    <div class='report'>
        <form action="{% url 'neighborhood:home' %}" method="POST">
            {% csrf_token %}
            {{ report_form.as_p }}
{#            <button id="close-report" class="btn btn-default">Close</button>#}
            <button id="submit-report" class="btn btn-default">Submit</button>
        </form>
    </div>
</div>

<div id="content" class="content">
    <div class="feed">
        <h1 id="feed-title" class="orange-text">Neighborly News Now.</h1>
        <span class="blue"></span>
            {% for post in feedposts %}
                <div class="feed-item">
                    <h2>{{ post.title }}</h2>
                    {% if post.type == 'MARKER' %}
                        <p><strong>{{ post.user }}</strong> placed a marker! <br />
                            <strong>{{ post.marker.type_of_marker }}</strong> - <small>{{ post.create_date }}</small></p>
                    {% elif post.type == 'ANNOUNCEMENT' %}
                        <p>{{ post.description }}</p>
                        <small><strong>{{ post.user }}</strong> {{ post.create_date }}</small>
                    {% elif post.type == 'POLL' %}
                        <p>{{ post.description }}</p>
                        <button id="" class="vote-yes">Yes
        {#                    <span class="glyphicon glyphicon-thumbs-up"></span>#}
                        </button>
                        <button id="" class="vote-no">No
        {#                    <span class="glyphicon glyphicon-thumbs-down"></span>#}
                        </button>
                    {% endif %}
                </div>
            {% endfor %}
            {#            <p>Nothing worthy of your time right now, sir.</p>#}
{#            <div class="feed-item">#}
{#                <h2>New Poll</h2>#}
{#                <p>Should we allocate funds for road repairs?</p>#}
{##}
{#                <button id="vote-yes" class="">Yes#}
{#                    <span class="glyphicon glyphicon-thumbs-up"></span>#}
{#                </button>#}
{#                <button id="vote-no" class="">No#}
{#                    <span class="glyphicon glyphicon-thumbs-down"></span>#}
{#                </button>#}
{#                <br />#}
{#            </div>#}
{##}
{#            <div class="feed-item">#}
{#                <h2>Announcement</h2>#}
{#                <p>As of October 10th, 2016, residence fees will increase from#}
{#                $175 a month to $200 a month. Please plan accordingly.</p>#}
{##}
{#                <button id="contact" class="">Contact Administrator</button>#}
{#            </div>#}
{##}
{##}
{#            <div class="feed-item">#}
{#                <h2>Yard Sale</h2>#}
{#                <p>Hey everyone! I've got tons of old collectibles and such that I just#}
{#                    can't find room for anymore. It would be greatly appreciated if ya'll#}
{#                came on down for a looksey!</p>#}
{#                <br />#}
{#                <small>from <strong>Dave Anderson</strong> on <strong>3/14/2016</strong></small>#}
{#            </div>#}
    </div>

    <div id='legend' style='display:none;'>
        <h2 class="orange-text"><strong>WHATS HOT IN THE HOOD.</strong></h2>
        <div id="leg_div" class='legend clearfix'>
            <span class="white"></span>
            <span class="green"></span>
            <span class="gray"></span>
            <span class="light-blue"></span>
            <span class="blue"></span>
            <small>Source: <a href="#link to source">Name of source</a></small>
        </div>
    </div>
    <div id='map' class='streets'></div>
</div>
<script>
</script>

<script src="{% static 'neighborhood/js/report.js' %}"></script>
<!--
<div class="footer">
    <div class="row">
        <div class="col-md-4">
            <h3>About</h3>
            <p>Info/links regarding Neighbors information.</p>
        </div>
        <div class="col-md-4">
            <h3>Contact</h3>
            <p>Info/links for contacting Neighbors peeps</p>
        </div>
        <div class="col-md-4">
            <h3>Help</h3>
            <p>Help and FAQ shit.</p>
        </div>
    </div>
</div>  end footer-->

<script>

    /**
     * CUSTOM ICON INSTANTIATION
     *
     * Types of Markers -
     *
            HOUSE = 'HOU'
            EVENT = 'EVE'
            TRASH = 'TRA'
            CONSTRUCTION = 'CON'
            POOL = 'POL'
            SPA = 'SPA'
            THEFT = 'THF'
            YARD_SALE = 'YAR'
     */

    /**
     * MARKER TYPE SELECTION POPUP
     */


    //For getting CSRF token
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    // Grab csrf token for AJAX calls
    var csrftoken = getCookie('csrftoken');



    L.mapbox.accessToken = 'pk.eyJ1IjoicGFidWx1bSIsImEiOiIwZTUwZmViZjQxZjYyMDJmNTQ0ZDY3YTdkNDE5ZjM0ZCJ9.MZqD7DtnmRFQfWLMGRMP_w';
    var map = L.mapbox.map('map', 'mapbox.streets', {
        legendControl: {
            position: 'topleft'
        },
        zoomControl: false
    }).setView([34.220912, -119.055079], 16);

    // move zoom control location to top right corner
    new L.Control.Zoom({ position: 'topright' }).addTo(map);

    //map.legendControl.addLegend(document.getElementById('legend').innerHTML);

    // Create holders for new marker info
    var name = "Sample Marker Name";
    var lat, lon;
    var pin;
    var type_of_marker = "YARD_SALE";
    var mark_latlng;

    // create new custom icon



    map.on('click', function (e) {
        if (pin != null) { // pin placed already, move it
            pin.setLatLng(e.latlng).openPopup();
            mark_latlng = e.latlng;
        }
        else { // no pin yet, make new pin
            mark_latlng = e.latlng;
            pin = new L.marker(mark_latlng).addTo(map)
                    .bindPopup('<button id=house>House</button><button id=event>Event</button><br />' +
                            '<button id=const>Construction</button><button id=trash>Trash</button><br />' +
                            '<button id=theft>Theft</button><button id=yard>Yard Sale</button><br />' +
                            '<button class=default>Default</button><button class=save>SAVE</button>')
                    .openPopup();
        }
    });

    $(document).ready(function() {
        // Getting all markers in db and loading to map



        $.ajax({
            url: "{% url 'markers:get_all_markers' %}",
            type: 'GET',
            data: {
                csrfmiddlewaretoken: csrftoken
            },
            dataType: "json",
            success: function (data) {
                //alert('markers received' + data);
                $.each(data.markers, function (markerIndex, marker) {
                    //alert(marker.type_of_marker + " marker loaded at:" + marker['lat'] +", " + marker['lon']);
                    //L.marker([marker['lat'], marker['lon']]).addTo(map);
                    L.marker([marker['lat'], marker['lon']]).setIcon(getIconType(marker.type_of_marker)).addTo(map);
                });
            },
            error: function (xhr, errmsg, err) {
                alert('ERROR: ' + xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });

        $('#map').on('click', '#house', function () {
            type_of_marker = "HOUSE";
            pin.setIcon(getIconType(type_of_marker));
        });
        $('#map').on('click', '#yard', function () {
            type_of_marker = "YARD_SALE";
            pin.setIcon(getIconType(type_of_marker));
        });
        $('#map').on('click', '#const', function () {
            type_of_marker = "CONSTRUCTION";
            pin.setIcon(getIconType(type_of_marker));
        });
        $('#map').on('click', '#theft', function () {
            type_of_marker = "THEFT";
            pin.setIcon(getIconType(type_of_marker));
        });
        $('#map').on('click', '#event', function () {
            type_of_marker = "EVENT";
            pin.setIcon(getIconType(type_of_marker));
        });
        $('#map').on('click', '#trash', function () {
            type_of_marker = "TRASH";
            pin.setIcon(getIconType(type_of_marker));
        });
        $('#map').on('click', '#default', function () {
            type_of_marker = "TRASH";
            pin.setIcon(getIconType(type_of_marker));
        });
        $('#map').on('click', '.save', function () {
            // AJAX call to save new marker as GeoDjango model
            $.ajax({
                url: "{% url 'markers:new_marker' %}",
                type: "Post",
                data: {
                    name: name,
                    lat: mark_latlng.lat,
                    lon: mark_latlng.lng,
                    type_of_marker: type_of_marker,
                    csrfmiddlewaretoken: csrftoken
                },
                success: function (json) {
                    console.log(json);
                    pin.closePopup();
                    alert('Created a ' + type_of_marker + ' marker at latitude:' + json['lat'] + ' and longitude:' + json['lon']);
                    L.marker([mark_latlng.lat, mark_latlng.lng]).setIcon(getIconType(type_of_marker)).addTo(map);
                    pin = null;

                },
                error: function (xhr, errmsg, err) {
                    alert('ERROR: ' + xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
            })
        });
    });

    function getIconType(type) {
        switch (type) {
            case 'HOUSE':
                return new L.icon({
                    iconUrl: "{% static 'markers/png/house-32.png' %}",
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                break;
            case 'YARD_SALE':
                return new L.icon({
                    iconUrl: "{% static 'markers/png/shopping-tag-32.png' %}",
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                break;
            case 'CONSTRUCTION':
                return new L.icon({
                    iconUrl: "{% static 'markers/png/bulldozer-32.png' %}",
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                break;
            case 'THEFT':
                return new L.icon({
                    iconUrl: "{% static 'markers/png/burglar-32.png' %}",
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                break;
            case 'EVENT':
                return new L.icon({
                    iconUrl: "{% static 'markers/png/event-32.png' %}",
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                break;
            case 'TRASH':
                return new L.icon({
                    iconUrl: "{% static 'markers/png/trash-32.png' %}",
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                break;
            case 'DEFAULT':
                return new L.Icon.Default;
                break;
            default:
                return new L.Icon.Default;
                break;
        }
    }

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
</script>
</body>
</html>